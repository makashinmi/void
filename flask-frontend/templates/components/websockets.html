<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>

<script type='text/javascript' charset='utf-8'>
	const socket = io();

	const form = document.getElementById('form');
	const input = document.getElementById('input');
	const query_results = document.getElementById('query_results');
	const playlist = document.getElementById('playlist');

	form.addEventListener('submit', (e) => {
		e.preventDefault();
		if (input.value) {
			input.setAttribute('disabled', '');
			input.nextSibling.setAttribute('disabled', '');
			query_results.innerHTML = `Searching for "${input.value}"...`;
			socket.emit('track_query', input.value);
			input.value = '';
		}
	});

	socket.on('connect', function() {
		socket.emit('my event', {data: "I'm connected!'"});
	});

	function track_query_choice(id) {
		socket.emit('track_query_choice', id);
		query_results.innerHTML = '';
		const temp = document.createElement('div');
		temp.setAttribute('id', id);
		temp.innerHTML = `${id} &mdash; in progress`;
		playlist.appendChild(temp);
	};

	socket.on('track_query_result', (result) => {
		input.removeAttribute('disabled');
		input.nextSibling.removeAttribute('disabled');
		query_results.innerHTML = '';

		for(let i = 0; i < result.length; i++) {
			const row = document.createElement('div');
			row.setAttribute('class', 'track-query-option');

			var track = result[i];
			row.setAttribute('onclick', `track_query_choice('${track.id}')`);

			var seconds = track.duration_seconds % 60;
			var minutes = (track.duration_seconds - seconds) / 60;
			if (seconds < 10) {
				seconds = `0${seconds}`;
			};
			row.innerHTML = `<b>${track.author}</b> &mdash; ${track.name} (${minutes}:${seconds})`;
			query_results.appendChild(row);
		};
	});

	socket.on('track_query_finish', (data_obj) => {
		const track = document.createElement('div');
		track.innerHTML = `<audio controls><source src='${data_obj.path}' type='audio/webm'></audio>`
		var temp = document.getElementById(data_obj.id);
		temp.parentNode.removeChild(temp);
		playlist.appendChild(track);
	});
</script>
